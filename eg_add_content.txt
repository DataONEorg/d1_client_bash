Adding content to a Member Node
===============================

Getting Started
---------------

Everything here will be done with the command line. Dependencies are:

* subversion
* xmlstarlet
* openssl
* BASH 3+
* python-pyasn1
* python-lxml
* d1_client_bash

Install the scripts::

  cd ~/bin
  svn co https://repository.dataone.org/software/cicore/trunk/itk/d1_client_bash

Add the folder to your path by appending the following to your .profile::

  # set PATH for d1_client_bash
  if [ -d "${HOME}/bin/d1_client_bash" ]; then
    PATH="${PATH}:${HOME}/bin/d1_client_bash"
  fi

Reload the profile::

  . ~/.profile

Verify that the scripts seem to be ok::

  d1listobjects -b "https://cn.dataone.org/cn"

The output should be some info log messages and three lines of output (the 
default operation lists three lines).

Create some file that will be loaded to the MN::

  $ cat test.txt
  This is a test
  - DV


For convenience, add the MN baseurl to an environment variable::

  export MNODE="https://flynn-gmn-1.test.dataone.org/mn"


Get a Client certificate
------------------------

Logon to https://cilogon.org/?skin=dataone

Download certificate via jnlp app.

Check the client certificate::

  $ d1mysubject.py x509up_u501 
  INFO:root:Certificate OK
  INFO:root:Issuer: CN=CILogon OpenID CA 1,O=CILogon,C=US,DC=cilogon,DC=org
  INFO:root:Not before: 20150908195011Z
  INFO:root:Not after: 20150909135511Z
  CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org

Subject is::

  CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org

This entry can be placed verbatim in the GMN whitelist.txt file.

Example of expired client certificate output::

  $ d1mysubject.py x509up_u501 
  WARNING:root:Certificate has expired!
  INFO:root:Issuer: CN=CILogon OpenID CA 1,O=CILogon,C=US,DC=cilogon,DC=org
  INFO:root:Not before: 20150903150500Z
  INFO:root:Not after: 20150904091000Z
  CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org


Create System Metadata
----------------------

This is sysmeta for an object that will be publicly readable and has identifier 
"dv.test.002"::

  d1createsysmeta -E x509up_u501 -i dv.test.002 -f "text/plain" > sysmeta.xml

Take a look at the system metadata::

  cat sysm.xml

  <?xml version="1.0" encoding="UTF-8"?>
  <ns1:systemMetadata xmlns:ns1="http://ns.dataone.org/service/types/v1">
    <!-- 
      Warning: This file was generated by an automated process. Manual edits may 
      be overwritten without further warning.
      timestamp: 2015-09-08T20:03:36
      created_with: d1createsysmeta
      -->
    <serialVersion>0</serialVersion>
    <identifier>dv.test.002</identifier>
    <formatId>text/plain</formatId>
    <size>21</size>
    <checksum algorithm="MD5">43c7c7bbc83c1f4ad9b7d81bc3728333</checksum>
    <submitter>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</submitter>
    <rightsHolder>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</rightsHolder>
    <accessPolicy>
      <allow>
        <subject>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</subject>
        <permission>write</permission>
      </allow>
      <allow>
        <subject>public</subject>
        <permission>read</permission>
      </allow>
    </accessPolicy>
    <replicationPolicy replicationAllowed="true" numberReplicas="3"/>
    <dateUploaded>2015-09-08T20:03:36.000+00:00</dateUploaded>
    <dateSysMetadataModified>2015-09-08T20:03:36.000+00:00</dateSysMetadataModified>
  </ns1:systemMetadata>


Create the object on the MN
---------------------------

Upload the object to the MN by calling the Create method:: 

  d1create -E x509up_u501 \
           -b ${MNODE} \
           sysm.xml test.txt 

Response::

  <?xml version="1.0"?>
  <ns1:identifier xmlns:ns1="http://ns.dataone.org/service/types/v1">dv.test.002</ns1:identifier>

The equivalent command using just curl would be::

  curl -k -E x509up_u501 -X POST -F "pid=dv.test.002" -F "object=@stests.txt" \
  -F "sysmeta=@stests.sysmeta" "${MNODE}/v1/object"


Get the object System Metadata
------------------------------

Check that all seems OK by retrieving the system metadata::

  d1sysmeta -b "${MNODE}" "dv.test.002"

  <?xml version="1.0"?>
  <ns1:systemMetadata xmlns:ns1="http://ns.dataone.org/service/types/v1">
    <serialVersion>2</serialVersion>
    <identifier>dv.test.002</identifier>
    <formatId>text/plain</formatId>
    <size>21</size>
    <checksum algorithm="MD5">43c7c7bbc83c1f4ad9b7d81bc3728333</checksum>
    <submitter>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</submitter>
    <rightsHolder>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</rightsHolder>
    <accessPolicy>
      <allow>
        <subject>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</subject>
        <permission>write</permission>
      </allow>
      <allow>
        <subject>public</subject>
        <permission>read</permission>
      </allow>
    </accessPolicy>
    <replicationPolicy numberReplicas="3" replicationAllowed="true"/>
    <dateUploaded>2015-09-08T20:07:30.913582</dateUploaded>
    <dateSysMetadataModified>2015-09-08T20:07:30.970866Z</dateSysMetadataModified>
    <originMemberNode>urn:node:mnTestFLYNN</originMemberNode>
    <authoritativeMemberNode>urn:node:mnTestFLYNN</authoritativeMemberNode>
  </ns1:systemMetadata>

The equivalent command using curl would be::

  curl -k "${MNODE}/v1/meta/dv.test.002"


Create Restricted Access Content
--------------------------------

Delete the allow public read acl and update the identifier. Manually edit the 
xml and remove the second allow acl and change the identifier, or alternatively 
use xmlstarlet::

  xml ed -d //allow[2] -u //identifier -v "dv.test.003" sysm.xml > sysm2.xml

Here's what the modified system metadata looks like::

  cat sysm2.xml 

  <?xml version="1.0" encoding="UTF-8"?>
  <ns1:systemMetadata xmlns:ns1="http://ns.dataone.org/service/types/v1">
    <!-- 
      Warning: This file was generated by an automated process. Manual edits may 
      be overwritten without further warning.
      timestamp: 2015-09-08T20:03:36
      created_with: d1createsysmeta
      -->
    <serialVersion>0</serialVersion>
    <identifier>dv.test.003</identifier>
    <formatId>text/plain</formatId>
    <size>21</size>
    <checksum algorithm="MD5">43c7c7bbc83c1f4ad9b7d81bc3728333</checksum>
    <submitter>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</submitter>
    <rightsHolder>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</rightsHolder>
    <accessPolicy>
      <allow>
        <subject>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</subject>
        <permission>write</permission>
      </allow>
    </accessPolicy>
    <replicationPolicy replicationAllowed="true" numberReplicas="3"/>
    <dateUploaded>2015-09-08T20:03:36.000+00:00</dateUploaded>
    <dateSysMetadataModified>2015-09-08T20:03:36.000+00:00</dateSysMetadataModified>
  </ns1:systemMetadata>

Add the object to the MN using the modified system metadata::

  d1create -E x509up_u501 \
           -b ${MNODE}  sysm2.xml test.txt 

  <?xml version="1.0"?>
  <ns1:identifier xmlns:ns1="http://ns.dataone.org/service/types/v1">dv.test.003</ns1:identifier>

The equivalent command using just curl would be::

  curl -k -E x509up_u501 -X POST -F "pid=dv.test.003" -F "object=@stests.txt" \
  -F "sysmeta=@stests.sysmeta" "${MNODE}/v1/object"


Get the object system metadata::

  d1sysmeta -E x509up_u501 -b ${MNODE}  dv.test.003

  <?xml version="1.0"?>
  <ns1:systemMetadata xmlns:ns1="http://ns.dataone.org/service/types/v1">
    <serialVersion>2</serialVersion>
    <identifier>dv.test.003</identifier>
    <formatId>text/plain</formatId>
    <size>21</size>
    <checksum algorithm="MD5">43c7c7bbc83c1f4ad9b7d81bc3728333</checksum>
    <submitter>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</submitter>
    <rightsHolder>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</rightsHolder>
    <accessPolicy>
      <allow>
        <subject>CN=Dave Vieglais A335,O=Google,C=US,DC=cilogon,DC=org</subject>
        <permission>write</permission>
      </allow>
    </accessPolicy>
    <replicationPolicy numberReplicas="3" replicationAllowed="true"/>
    <dateUploaded>2015-09-08T20:15:49.7859</dateUploaded>
    <dateSysMetadataModified>2015-09-08T20:15:49.837231Z</dateSysMetadataModified>
    <originMemberNode>urn:node:mnTestFLYNN</originMemberNode>
    <authoritativeMemberNode>urn:node:mnTestFLYNN</authoritativeMemberNode>
  </ns1:systemMetadata>

Equivalent with curl::

  curl -E x509up_u501 -k "${MNODE}/v1/meta/dv.test.003"  

Looking good. Now try and retrieve the object::

  curl -E x509up_u501 -k "${MNODE}/v1/object/dv.test.003"

Output::

  This is a test
  - DV


